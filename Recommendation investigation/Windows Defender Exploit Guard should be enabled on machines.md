## Windows Defender Exploit Guard should be enabled on machines

Recommendation name
```
Windows Defender Exploit Guard should be enabled on machines
```
Policy definition id
```
bed48b13-6647-468e-aa2f-1af1d3f4dd40
```
Assessment Key
```
22489c48-27d1-4e40-9420-4303ad9cffef
```

ARG query to check the results in Azure policy and MDFC recommendation
```kusto
ARG

securityresources
| where type == "microsoft.security/assessments"
| where subscriptionId == "<your subscription id>"
| where name == "22489c48-27d1-4e40-9420-4303ad9cffef" 
| extend resourceName = tostring(split(tolower(extract("(.*)/providers/Microsoft.Security",1, id)),"/")[-1])
| extend statusInMdc = properties.status.code
| project resourceName, statusInMdc
| join
(
policyresources
| where type == "microsoft.policyinsights/policystates"
| where subscriptionId == "<your subscription id>"
| where * contains "bed48b13-6647-468e-aa2f-1af1d3f4dd40"
| extend resourceName = tostring(split(tolower(extract("(.*)/providers/microsoft.policyinsights",1, id)),"/")[-1])
| extend statusInPolicy = properties.complianceState
| project resourceName, statusInPolicy
) on resourceName
| project resourceName, statusInMdc, statusInPolicy![image](https://github.com/guguji666666/GJS-MDC-Tips/assets/96930989/8571216e-8c2e-4350-8d24-61648f216929)
```

## Steps tp remediate the recommendation
### 1. [Enable controlled folder access](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-controlled-folders?view=o365-worldwide)
![image](https://github.com/guguji666666/GJS-MDC-Tips/assets/96930989/53bccbb5-d5df-49d8-8c3a-e932f2f095cf)

#### Enable the function using powershell commands

Please check if the function has been enabled using [GPO](https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/enable-controlled-folders?view=o365-worldwide#group-policy) before, if the GPO already configured that, the powershell commands can't overrider the setting.

```powershell
## Enable ControlledFolderAccess
Set-MpPreference -EnableControlledFolderAccess Enabled
```

```powershell
## Check if the function has been enabled
Get-MpPreference
```

The value should be 1 if the function is enabled <br>
![image](https://github.com/guguji666666/GJS-MDC-Tips/assets/96930989/0ad8088e-14b8-4266-881a-6dfd09269b7b)

The value would be 2 if the function is in audit mode <br>
![image](https://github.com/guguji666666/GJS-MDC-Tips/assets/96930989/721e475f-0fd5-463b-8f54-078016cc99bd)

### 2. Set the Rules Action using powershell commands
```powershell
$asrr_ids = '5beb7efe-fd9a-4556-801d-275e5ffc04cc','be9ba2d9-53ea-4cdc-84e5-9b1eeee46550','b2b3f03d-6a65-4f7b-a9c7-1c7ef74a9ba4','92e97fa1-2edf-4476-bdd6-9dd0b4dddc7b','d4f940ab-401b-4efc-aadc-ad5f3c50688a','7674ba52-37eb-4a4f-a9a1-f0f9a1619a2c','d3e037e1-3eb8-44c8-a917-57927947596d','3b576869-a4ec-4529-8536-b80a7769e899', 'b7efe-fd9a-4556-801d-275e5ffc04', '9e6c4e1f-7d60-472f-ba1a-a39ef669e4b2', '26190899-1602-49e8-8b27-eb1d0a1ce869'
foreach ($id in $asrr_ids) { 
    Add-MpPreference -AttackSurfaceReductionRules_Ids $id -AttackSurfaceReductionRules_Actions Enabled
}
```

```powershell
## List rules action configured for verification
$mp = Get-MpPreference
$mp.AttackSurfaceReductionRules_Ids
$mp.AttackSurfaceReductionRules_Actions
```



